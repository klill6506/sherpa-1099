# Session Notes - 2026-01-14

## Summary
Continued Internet Deployment Plan. Completed Phases 1-3.

## What Was Done

### Phase 1: Authentication ✅ (completed in previous session)
- Microsoft OAuth via Supabase Auth
- httpOnly secure cookies
- Fixed Azure permissions issue (needed to grant admin consent + add explicit scopes)

### Phase 2: Tenant Isolation ✅
- Created `database/migrations/004_tenants.sql`:
  - `tenants` table
  - `tenant_members` table with roles (admin, staff, readonly)
  - Added `tenant_id` to: filers, recipients, forms_1099, submissions, import_batches, import_history, activity_log
  - Default tenant "The Tax Shelter" with fixed UUID
  - Migrated existing data to default tenant

- Created `database/migrations/005_tenant_rls.sql`:
  - RLS policies for tenant isolation on all tables
  - `get_user_tenant_ids()` helper function

- Updated `api/auth.py`:
  - Added `TenantInfo` dataclass
  - Added tenants list to `CurrentUser`
  - Auto-adds new users to default tenant on first login

**Migrations applied to Supabase:** Yes ✅

### Phase 3: Rate Limiting ✅
- Added `slowapi>=0.1.9` to requirements.txt
- Updated `api/main.py`:
  - Rate limiter initialization
  - Custom key function (IP for auth, user token for API)
  - Exception handler for rate limit exceeded

- Updated `api/routers/auth.py`:
  - /login: 10/minute per IP
  - /auth/microsoft: 5/minute per IP
  - /auth/callback: 10/minute per IP
  - /auth/me: 30/minute per IP

- Updated `api/routers/imports.py`:
  - /api/imports/quick: 10/minute per IP
  - /api/imports/upload: 10/minute per IP
  - /api/imports/upload-single: 10/minute per IP

## Server Setup Note
The server (C:\sherpa-1099) uses system Python, not a venv. To install new dependencies:
```powershell
pip install slowapi
```

Then restart the API.

## What's Next
- **Phase 4: TIN Protection** - Encrypt TINs at rest with Fernet
- **Phase 5: Deployment** - Dockerfile, staging, production

## Files Modified This Session
- `requirements.txt` - Added slowapi
- `api/main.py` - Rate limiter setup
- `api/auth.py` - Tenant support
- `api/routers/auth.py` - Rate limits + OAuth scopes
- `api/routers/imports.py` - Rate limits on uploads
- `database/migrations/004_tenants.sql` - NEW
- `database/migrations/005_tenant_rls.sql` - NEW
- `docs/INTERNET_DEPLOYMENT_PLAN.md` - Updated status

## Reference
Full deployment plan: `docs/INTERNET_DEPLOYMENT_PLAN.md`
