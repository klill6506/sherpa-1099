{% extends "base.html" %}

{% block title %}Review Import - Sherpa 1099{% endblock %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Review Import</h1>
        <p class="text-gray-600">{{ batch.filename }}</p>
    </div>
    <a href="/imports" class="text-primary hover:underline">&larr; Back to Imports</a>
</div>

<div x-data="reviewPage()" x-init="init()">
    <!-- Batch Summary -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div>
                <p class="text-sm text-gray-500">Status</p>
                <span class="px-2 py-1 text-sm rounded-full
                    {% if batch.status == 'promoted' %}bg-green-100 text-green-800
                    {% elif batch.status == 'validated' %}bg-blue-100 text-blue-800
                    {% elif batch.status == 'failed' %}bg-red-100 text-red-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ batch.status }}
                </span>
            </div>
            <div>
                <p class="text-sm text-gray-500">Total Rows</p>
                <p class="text-xl font-semibold">{{ batch.total_rows }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">Valid</p>
                <p class="text-xl font-semibold text-green-600">{{ batch.valid_rows }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">Errors</p>
                <p class="text-xl font-semibold text-red-600">{{ batch.error_rows }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">Warnings</p>
                <p class="text-xl font-semibold text-yellow-600">{{ batch.warning_rows }}</p>
            </div>
        </div>
    </div>

    <!-- Column Mapping -->
    <div class="bg-white rounded-lg shadow p-6 mb-6" x-show="batch.status !== 'promoted'">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Column Mapping</h2>
            <button @click="showMappingModal = true" class="text-primary hover:underline text-sm">
                Edit Mapping
            </button>
        </div>

        <div class="flex flex-wrap gap-2">
            {% if batch.column_mapping %}
                {% for source, target in batch.column_mapping.items() %}
                <div class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                    <span class="text-gray-600">{{ source }}</span>
                    <span class="text-gray-400 mx-1">&rarr;</span>
                    <span class="font-medium text-gray-900">{{ target }}</span>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-500">No mapping configured</p>
            {% endif %}
        </div>
    </div>

    <!-- Actions -->
    <div class="bg-white rounded-lg shadow p-6 mb-6" x-show="batch.status !== 'promoted'">
        <div class="flex flex-wrap gap-4">
            <!-- Validate Button -->
            <button @click="validateBatch()"
                    :disabled="isProcessing"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50">
                <span x-show="!isValidating">Validate Data</span>
                <span x-show="isValidating">Validating...</span>
            </button>

            <!-- Promote Button -->
            <template x-if="batch.status === 'validated' && batch.valid_rows > 0">
                <div class="flex items-center gap-2">
                    <select x-model="selectedFilerId" class="px-3 py-2 border rounded-md">
                        <option value="">-- Select Filer --</option>
                        {% for filer in filers %}
                        <option value="{{ filer.id }}">{{ filer.name }}</option>
                        {% endfor %}
                    </select>
                    <button @click="promoteBatch()"
                            :disabled="isProcessing || !selectedFilerId"
                            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50">
                        <span x-show="!isPromoting">Promote Valid Rows</span>
                        <span x-show="isPromoting">Promoting...</span>
                    </button>
                </div>
            </template>

            <!-- Delete Button -->
            <button @click="deleteBatch()"
                    :disabled="isProcessing"
                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50 ml-auto">
                Delete Batch
            </button>
        </div>

        <!-- Status Messages -->
        <template x-if="statusMessage">
            <div class="mt-4 p-3 rounded-md"
                 :class="statusType === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                <p x-text="statusMessage"></p>
            </div>
        </template>
    </div>

    <!-- Promoted Info -->
    {% if batch.status == 'promoted' %}
    <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
        <div class="flex items-center">
            <svg class="h-6 w-6 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
                <p class="font-medium text-green-800">Import Complete</p>
                <p class="text-sm text-green-600">{{ batch.valid_rows }} records were successfully promoted to recipients and forms.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Row Filter Tabs -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="border-b">
            <nav class="flex -mb-px">
                <button @click="filterStatus = ''"
                        :class="filterStatus === '' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-4 py-3 border-b-2 font-medium text-sm">
                    All (<span x-text="batch.total_rows"></span>)
                </button>
                <button @click="filterStatus = 'valid'"
                        :class="filterStatus === 'valid' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-4 py-3 border-b-2 font-medium text-sm">
                    Valid (<span x-text="batch.valid_rows"></span>)
                </button>
                <button @click="filterStatus = 'error'"
                        :class="filterStatus === 'error' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-4 py-3 border-b-2 font-medium text-sm">
                    Errors (<span x-text="batch.error_rows"></span>)
                </button>
                <button @click="filterStatus = 'warning'"
                        :class="filterStatus === 'warning' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-4 py-3 border-b-2 font-medium text-sm">
                    Warnings (<span x-text="batch.warning_rows"></span>)
                </button>
            </nav>
        </div>

        <!-- Rows Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Row</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TIN</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">City/State</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Issues</th>
                        <th class="px-4 py-3"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    <template x-for="row in filteredRows" :key="row.id">
                        <tr :class="row.status === 'error' ? 'bg-red-50' : (row.status === 'warning' ? 'bg-yellow-50' : '')">
                            <td class="px-4 py-3 text-sm text-gray-900" x-text="row.row_number"></td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 text-xs rounded-full"
                                      :class="{
                                          'bg-green-100 text-green-800': row.status === 'valid',
                                          'bg-red-100 text-red-800': row.status === 'error',
                                          'bg-yellow-100 text-yellow-800': row.status === 'warning',
                                          'bg-gray-100 text-gray-800': row.status === 'pending'
                                      }"
                                      x-text="row.status"></span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-900" x-text="row.recipient_name || '-'"></td>
                            <td class="px-4 py-3 text-sm font-mono text-gray-600" x-text="row.recipient_tin || '-'"></td>
                            <td class="px-4 py-3 text-sm text-gray-600" x-text="(row.recipient_city || '') + (row.recipient_state ? ', ' + row.recipient_state : '')"></td>
                            <td class="px-4 py-3 text-sm text-gray-600" x-text="row.form_type || '-'"></td>
                            <td class="px-4 py-3 text-sm text-gray-900" x-text="row.nec_box1 ? '$' + Number(row.nec_box1).toLocaleString() : '-'"></td>
                            <td class="px-4 py-3">
                                <template x-if="row.validation_errors && row.validation_errors.length > 0">
                                    <div class="text-xs">
                                        <template x-for="err in row.validation_errors" :key="err.field + err.code">
                                            <span class="block text-red-600" x-text="err.message"></span>
                                        </template>
                                    </div>
                                </template>
                            </td>
                            <td class="px-4 py-3">
                                <button @click="editRow(row)" class="text-primary hover:underline text-sm"
                                        x-show="row.status !== 'valid' && batch.status !== 'promoted'">
                                    Edit
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="px-4 py-3 border-t flex items-center justify-between">
            <p class="text-sm text-gray-500">
                Showing <span x-text="rows.length"></span> rows
            </p>
            <div class="flex gap-2">
                <button @click="loadRows(offset - limit)" :disabled="offset === 0"
                        class="px-3 py-1 border rounded text-sm disabled:opacity-50">Previous</button>
                <button @click="loadRows(offset + limit)" :disabled="rows.length < limit"
                        class="px-3 py-1 border rounded text-sm disabled:opacity-50">Next</button>
            </div>
        </div>
    </div>

    <!-- Edit Row Modal -->
    <div x-show="editingRow" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Edit Row <span x-text="editingRow?.row_number"></span></h3>
                    <button @click="editingRow = null" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Recipient Name</label>
                        <input type="text" x-model="editingRow.recipient_name"
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">TIN (SSN/EIN)</label>
                        <input type="text" x-model="editingRow.recipient_tin"
                               class="w-full px-3 py-2 border rounded-md font-mono">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                        <input type="text" x-model="editingRow.recipient_address1"
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
                        <input type="text" x-model="editingRow.recipient_city"
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                        <input type="text" x-model="editingRow.recipient_state" maxlength="2"
                               class="w-full px-3 py-2 border rounded-md uppercase">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ZIP</label>
                        <input type="text" x-model="editingRow.recipient_zip"
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Form Type</label>
                        <select x-model="editingRow.form_type" class="w-full px-3 py-2 border rounded-md">
                            <option value="1099-NEC">1099-NEC</option>
                            <option value="1099-MISC">1099-MISC</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Amount (Box 1)</label>
                        <input type="number" step="0.01" x-model="editingRow.nec_box1"
                               class="w-full px-3 py-2 border rounded-md">
                    </div>
                </div>

                <!-- Raw Data Preview -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Original Data</label>
                    <pre class="bg-gray-50 p-3 rounded text-xs overflow-x-auto" x-text="JSON.stringify(editingRow?.raw_data, null, 2)"></pre>
                </div>

                <div class="mt-6 flex justify-end gap-3">
                    <button @click="editingRow = null" class="px-4 py-2 border rounded-md">Cancel</button>
                    <button @click="saveRow()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">
                        Save & Re-validate
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function reviewPage() {
    return {
        batch: {{ batch | tojson }},
        rows: [],
        filterStatus: '',
        offset: 0,
        limit: 100,
        isProcessing: false,
        isValidating: false,
        isPromoting: false,
        statusMessage: '',
        statusType: '',
        editingRow: null,
        showMappingModal: false,
        selectedFilerId: '{{ batch.filer_id or "" }}',

        get filteredRows() {
            if (!this.filterStatus) return this.rows;
            return this.rows.filter(r => r.status === this.filterStatus);
        },

        async init() {
            await this.loadRows(0);
        },

        async loadRows(newOffset) {
            this.offset = Math.max(0, newOffset);
            const status = this.filterStatus || '';
            const url = `/api/imports/batches/{{ batch.id }}/rows?limit=${this.limit}&offset=${this.offset}` +
                        (status ? `&status=${status}` : '');

            try {
                const response = await fetch(url);
                this.rows = await response.json();
            } catch (error) {
                console.error('Failed to load rows:', error);
            }
        },

        async validateBatch() {
            this.isValidating = true;
            this.isProcessing = true;
            this.statusMessage = '';

            try {
                const response = await fetch(`/api/imports/batches/{{ batch.id }}/validate`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Validation failed');
                }

                const stats = await response.json();
                this.batch.valid_rows = stats.valid;
                this.batch.error_rows = stats.errors;
                this.batch.warning_rows = stats.warnings;
                this.batch.status = 'validated';

                this.statusMessage = `Validation complete: ${stats.valid} valid, ${stats.errors} errors, ${stats.warnings} warnings`;
                this.statusType = 'success';

                await this.loadRows(0);

            } catch (error) {
                this.statusMessage = error.message;
                this.statusType = 'error';
            } finally {
                this.isValidating = false;
                this.isProcessing = false;
            }
        },

        async promoteBatch() {
            if (!this.selectedFilerId) {
                this.statusMessage = 'Please select a filer';
                this.statusType = 'error';
                return;
            }

            this.isPromoting = true;
            this.isProcessing = true;
            this.statusMessage = '';

            try {
                const response = await fetch(`/api/imports/batches/{{ batch.id }}/promote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filer_id: this.selectedFilerId })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Promotion failed');
                }

                const stats = await response.json();
                this.batch.status = 'promoted';

                this.statusMessage = `Promoted ${stats.recipients_created} recipients and ${stats.forms_created} forms`;
                this.statusType = 'success';

                // Reload page to show promoted state
                setTimeout(() => window.location.reload(), 1500);

            } catch (error) {
                this.statusMessage = error.message;
                this.statusType = 'error';
            } finally {
                this.isPromoting = false;
                this.isProcessing = false;
            }
        },

        async deleteBatch() {
            if (!confirm('Are you sure you want to delete this import batch? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/imports/batches/{{ batch.id }}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Delete failed');
                }

                window.location.href = '/imports';

            } catch (error) {
                this.statusMessage = error.message;
                this.statusType = 'error';
            }
        },

        editRow(row) {
            this.editingRow = { ...row };
        },

        async saveRow() {
            try {
                const response = await fetch(`/api/imports/rows/${this.editingRow.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recipient_name: this.editingRow.recipient_name,
                        recipient_tin: this.editingRow.recipient_tin,
                        recipient_address1: this.editingRow.recipient_address1,
                        recipient_city: this.editingRow.recipient_city,
                        recipient_state: this.editingRow.recipient_state,
                        recipient_zip: this.editingRow.recipient_zip,
                        form_type: this.editingRow.form_type,
                        nec_box1: this.editingRow.nec_box1
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Update failed');
                }

                this.editingRow = null;
                this.statusMessage = 'Row updated. Re-validate the batch to check for errors.';
                this.statusType = 'success';
                await this.loadRows(this.offset);

            } catch (error) {
                this.statusMessage = error.message;
                this.statusType = 'error';
            }
        }
    }
}
</script>
{% endblock %}
