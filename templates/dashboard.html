{% extends "base.html" %}

{% block title %}Sherpa 1099{% endblock %}

{% block content %}
<div x-data="homePage()" x-init="loadFilingStatus()" class="space-y-6">
    <!-- Welcome Header -->
    <div class="glass rounded-2xl shadow-glass p-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold theme-text">Welcome back, {{ user.display_name if user else 'Guest' }}</h1>
                <p class="theme-muted">Tax Year {{ operating_year.year if operating_year else '2025' }} &middot; <span x-text="summary.total || 0"></span> filers</p>
            </div>
            <div class="flex gap-3">
                <a href="/imports/upload" class="inline-flex items-center px-4 py-2 bg-sherpa-blue hover:bg-blue-600 text-white rounded-xl text-sm font-medium transition-colors shadow-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    Import Data
                </a>
                <a href="/filers/new" class="inline-flex items-center px-4 py-2 bg-sherpa-green hover:bg-emerald-600 text-white rounded-xl text-sm font-medium transition-colors shadow-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Filer
                </a>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
        <div class="glass rounded-xl shadow-glass-sm p-4 text-center">
            <div class="text-2xl font-bold theme-text" x-text="summary.total || 0"></div>
            <div class="text-xs theme-subtle">Total</div>
        </div>
        <div class="glass rounded-xl shadow-glass-sm p-4 text-center">
            <div class="text-2xl font-bold text-gray-500" x-text="summary.NOT_FILED || 0"></div>
            <div class="text-xs theme-subtle">Not Filed</div>
        </div>
        <div class="glass rounded-xl shadow-glass-sm p-4 text-center">
            <div class="text-2xl font-bold text-sherpa-amber" x-text="summary.SUBMITTED || 0"></div>
            <div class="text-xs theme-subtle">Submitted</div>
        </div>
        <div class="glass rounded-xl shadow-glass-sm p-4 text-center">
            <div class="text-2xl font-bold text-sherpa-amber" x-text="summary.PROCESSING || 0"></div>
            <div class="text-xs theme-subtle">Processing</div>
        </div>
        <div class="glass rounded-xl shadow-glass-sm p-4 text-center">
            <div class="text-2xl font-bold text-sherpa-blue" x-text="(summary.ACCEPTED || 0) + (summary.ACCEPTED_WITH_ERRORS || 0)"></div>
            <div class="text-xs theme-subtle">Accepted</div>
        </div>
        <div class="glass rounded-xl shadow-glass-sm p-4 text-center" :class="(summary.REJECTED || 0) > 0 ? 'ring-2 ring-sherpa-red/30' : ''">
            <div class="text-2xl font-bold" :class="(summary.REJECTED || 0) > 0 ? 'text-sherpa-red' : 'text-gray-500'" x-text="summary.REJECTED || 0"></div>
            <div class="text-xs" :class="(summary.REJECTED || 0) > 0 ? 'text-sherpa-red' : 'theme-subtle'">Rejected</div>
        </div>
    </div>

    <!-- Filters and Actions -->
    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
        <div class="flex-1 w-full sm:w-auto">
            <input type="text"
                   x-model="searchTerm"
                   placeholder="Search filers..."
                   class="w-full px-4 py-2.5 rounded-xl glass theme-text placeholder-gray-400 focus:ring-2 focus:ring-sherpa-blue focus:outline-none">
        </div>
        <select x-model="statusFilter"
                class="px-4 py-2.5 rounded-xl glass theme-text focus:ring-2 focus:ring-sherpa-blue focus:outline-none">
            <option value="">All Statuses</option>
            <option value="NOT_FILED">Not Filed</option>
            <option value="SUBMITTED">Submitted</option>
            <option value="PROCESSING">Processing</option>
            <option value="ACCEPTED">Accepted</option>
            <option value="REJECTED">Rejected</option>
        </select>
        <!-- Check All Statuses Button -->
        <button @click="checkAllStatuses()"
                :disabled="checkingAll || pendingCount === 0"
                class="px-4 py-2.5 rounded-xl bg-sherpa-amber hover:bg-amber-600 text-white text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
            <template x-if="!checkingAll">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Check All Statuses (<span x-text="pendingCount"></span>)
                </span>
            </template>
            <template x-if="checkingAll">
                <span class="flex items-center gap-2">
                    <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Checking <span x-text="checkProgress"></span>/<span x-text="pendingCount"></span>...
                </span>
            </template>
        </button>
    </div>

    <!-- All Filers Table -->
    <div class="glass rounded-2xl shadow-glass overflow-hidden">
        <!-- Loading State -->
        <template x-if="loading">
            <div class="p-12 text-center">
                <svg class="animate-spin h-8 w-8 mx-auto text-sherpa-blue" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 theme-muted">Loading filers...</p>
            </div>
        </template>

        <!-- Empty State -->
        <template x-if="!loading && filteredFilers.length === 0">
            <div class="p-12 text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-sherpa-blue/10 flex items-center justify-center">
                    <svg class="w-8 h-8 text-sherpa-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                </div>
                <p class="theme-muted mb-2">No filers found</p>
                <p class="theme-subtle text-sm mb-4">Import data or add a filer to get started.</p>
                <a href="/imports/upload" class="text-sherpa-blue hover:underline text-sm font-medium">
                    Import your first workbook &rarr;
                </a>
            </div>
        </template>

        <!-- Filers Table -->
        <template x-if="!loading && filteredFilers.length > 0">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="glass-light">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium theme-muted uppercase tracking-wider">Filer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium theme-muted uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium theme-muted uppercase tracking-wider">Forms</th>
                            <th class="px-6 py-3 text-left text-xs font-medium theme-muted uppercase tracking-wider">Receipt ID</th>
                            <th class="px-6 py-3 text-right text-xs font-medium theme-muted uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/20 dark:divide-sherpa-dark-border">
                        <template x-for="item in filteredFilers" :key="item.filer_id">
                            <tr class="hover:bg-white/30 dark:hover:bg-sherpa-dark-panel transition-colors">
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-9 h-9 rounded-lg bg-sherpa-blue/10 flex items-center justify-center flex-shrink-0">
                                            <span class="text-sherpa-blue font-semibold text-sm" x-text="item.filer_name.substring(0,2).toUpperCase()"></span>
                                        </div>
                                        <div class="min-w-0">
                                            <a :href="'/filers/' + item.filer_id" class="text-sm font-medium theme-text hover:text-sherpa-blue truncate block" x-text="item.filer_name"></a>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                          :class="getStatusClasses(item.status)"
                                          x-text="formatStatus(item.status)">
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm theme-muted" x-text="item.form_count || '-'"></td>
                                <td class="px-6 py-4">
                                    <template x-if="item.last_receipt_id">
                                        <span class="text-xs font-mono theme-subtle" x-text="item.last_receipt_id"></span>
                                    </template>
                                    <template x-if="!item.last_receipt_id">
                                        <span class="text-xs theme-subtle">-</span>
                                    </template>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex justify-end gap-2">
                                        <!-- Transmit button for NOT_FILED or no status -->
                                        <template x-if="!item.status || item.status === 'NOT_FILED'">
                                            <a :href="'/filers/' + item.filer_id + '/efile'"
                                               class="px-3 py-1.5 text-xs font-medium bg-sherpa-green hover:bg-emerald-700 text-white rounded-lg transition-colors">
                                                Transmit
                                            </a>
                                        </template>
                                        <!-- Check Status for SUBMITTED/PROCESSING -->
                                        <template x-if="item.last_receipt_id && ['SUBMITTED', 'PROCESSING'].includes(item.status)">
                                            <button @click="checkStatus(item)"
                                                    :disabled="item.checking"
                                                    class="px-3 py-1.5 text-xs font-medium bg-sherpa-amber hover:bg-amber-600 text-white rounded-lg transition-colors disabled:opacity-50">
                                                <span x-show="!item.checking">Check Status</span>
                                                <span x-show="item.checking">Checking...</span>
                                            </button>
                                        </template>
                                        <!-- View Errors for REJECTED -->
                                        <template x-if="item.status === 'REJECTED'">
                                            <button @click="viewErrors(item)"
                                                    class="px-3 py-1.5 text-xs font-medium bg-sherpa-red hover:bg-red-700 text-white rounded-lg transition-colors">
                                                View Errors
                                            </button>
                                        </template>
                                        <!-- Open button always -->
                                        <a :href="'/filers/' + item.filer_id"
                                           class="px-3 py-1.5 text-xs font-medium bg-sherpa-blue hover:bg-blue-700 text-white rounded-lg transition-colors">
                                            Open
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </template>
    </div>

    <!-- Errors Modal -->
    <template x-if="showErrorsModal">
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm" @click.self="showErrorsModal = false">
            <div class="glass rounded-2xl shadow-glass p-6 w-full max-w-lg">
                <h3 class="text-lg font-semibold theme-text mb-4">Filing Errors</h3>
                <p class="text-sm theme-muted mb-4"><span class="font-medium theme-text" x-text="selectedFiler?.filer_name"></span></p>

                <div class="bg-sherpa-red/10 border border-sherpa-red/20 rounded-xl p-4 mb-4 max-h-64 overflow-y-auto">
                    <template x-if="selectedErrors && selectedErrors.length > 0">
                        <ul class="space-y-2">
                            <template x-for="error in selectedErrors" :key="error">
                                <li class="text-sm text-sherpa-red" x-text="error"></li>
                            </template>
                        </ul>
                    </template>
                    <template x-if="!selectedErrors || selectedErrors.length === 0">
                        <p class="text-sm text-sherpa-red">No error details available.</p>
                    </template>
                </div>

                <div class="flex justify-end">
                    <button @click="showErrorsModal = false" class="px-4 py-2 bg-sherpa-blue hover:bg-blue-600 text-white rounded-xl text-sm font-medium transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </template>
</div>

<script>
function homePage() {
    return {
        taxYear: {{ operating_year.year if operating_year else 2025 }},
        loading: true,
        allFilers: [],
        summary: {},
        searchTerm: '',
        statusFilter: '',

        // Errors modal
        showErrorsModal: false,
        selectedFiler: null,
        selectedErrors: [],

        // Batch status check
        checkingAll: false,
        checkProgress: 0,

        get pendingCount() {
            return this.allFilers.filter(f =>
                f.last_receipt_id && ['SUBMITTED', 'PROCESSING'].includes(f.status)
            ).length;
        },

        get filteredFilers() {
            let result = this.allFilers;

            // Filter by status
            if (this.statusFilter) {
                result = result.filter(f => {
                    const status = f.status || 'NOT_FILED';
                    return status === this.statusFilter;
                });
            }

            // Filter by search term
            if (this.searchTerm) {
                const term = this.searchTerm.toLowerCase();
                result = result.filter(f => f.filer_name.toLowerCase().includes(term));
            }

            // Default sort: Rejected -> Not Filed -> Pending -> Accepted
            const statusOrder = {
                'REJECTED': 0,
                'NOT_FILED': 1,
                'SUBMITTED': 2,
                'PROCESSING': 3,
                'ACCEPTED': 4,
                'ACCEPTED_WITH_ERRORS': 5
            };

            result = [...result].sort((a, b) => {
                const statusA = a.status || 'NOT_FILED';
                const statusB = b.status || 'NOT_FILED';
                const orderA = statusOrder[statusA] ?? 99;
                const orderB = statusOrder[statusB] ?? 99;
                if (orderA !== orderB) return orderA - orderB;
                return a.filer_name.localeCompare(b.filer_name);
            });

            return result;
        },

        async loadFilingStatus() {
            this.loading = true;
            try {
                const response = await fetch(`/api/efile/filing-dashboard?tax_year=${this.taxYear}`);
                if (!response.ok) {
                    this.loading = false;
                    return;
                }

                const data = await response.json();
                this.summary = data.summary || {};
                this.allFilers = data.items || [];
            } catch (e) {
                console.error('Failed to load filers:', e);
            } finally {
                this.loading = false;
            }
        },

        async checkStatus(item) {
            if (!item.last_receipt_id) return;

            item.checking = true;
            try {
                const statusResponse = await fetch('/api/efile/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receipt_id: item.last_receipt_id })
                });

                if (!statusResponse.ok) throw new Error('Failed to check status');
                const statusResult = await statusResponse.json();

                // Map IRS status
                let newStatus = item.status;
                if (statusResult.status === 'accepted') newStatus = 'ACCEPTED';
                else if (statusResult.status === 'accepted_with_errors') newStatus = 'ACCEPTED_WITH_ERRORS';
                else if (statusResult.status === 'rejected') newStatus = 'REJECTED';
                else if (statusResult.status === 'processing') newStatus = 'PROCESSING';

                // Update if changed
                if (newStatus !== item.status) {
                    await fetch('/api/efile/filing-status/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filer_id: item.filer_id,
                            tax_year: this.taxYear,
                            status: newStatus,
                            errors: statusResult.errors?.length > 0 ? { errors: statusResult.errors } : null
                        })
                    });
                    await this.loadFilingStatus();
                } else {
                    alert(`Status: ${this.formatStatus(statusResult.status)}\n${statusResult.message || ''}`);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                item.checking = false;
            }
        },

        viewErrors(item) {
            this.selectedFiler = item;
            this.selectedErrors = item.last_errors?.errors || [];
            this.showErrorsModal = true;
        },

        async checkAllStatuses() {
            const pendingFilers = this.allFilers.filter(f =>
                f.last_receipt_id && ['SUBMITTED', 'PROCESSING'].includes(f.status)
            );

            if (pendingFilers.length === 0) {
                alert('No pending submissions to check.');
                return;
            }

            this.checkingAll = true;
            this.checkProgress = 0;

            let updated = 0;
            let errors = [];

            for (const item of pendingFilers) {
                this.checkProgress++;
                try {
                    const statusResponse = await fetch('/api/efile/status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ receipt_id: item.last_receipt_id })
                    });

                    if (!statusResponse.ok) {
                        errors.push(`${item.filer_name}: Failed to check`);
                        continue;
                    }

                    const statusResult = await statusResponse.json();

                    // Map IRS status
                    let newStatus = item.status;
                    if (statusResult.status === 'accepted') newStatus = 'ACCEPTED';
                    else if (statusResult.status === 'accepted_with_errors') newStatus = 'ACCEPTED_WITH_ERRORS';
                    else if (statusResult.status === 'rejected') newStatus = 'REJECTED';
                    else if (statusResult.status === 'processing') newStatus = 'PROCESSING';

                    // Update if changed
                    if (newStatus !== item.status) {
                        await fetch('/api/efile/filing-status/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                filer_id: item.filer_id,
                                tax_year: this.taxYear,
                                status: newStatus,
                                errors: statusResult.errors?.length > 0 ? { errors: statusResult.errors } : null
                            })
                        });
                        updated++;
                    }
                } catch (e) {
                    errors.push(`${item.filer_name}: ${e.message}`);
                }
            }

            this.checkingAll = false;

            // Reload to show updates
            await this.loadFilingStatus();

            // Show summary
            let message = `Checked ${pendingFilers.length} submission(s).`;
            if (updated > 0) message += `\n${updated} status(es) updated.`;
            if (errors.length > 0) message += `\n\nErrors:\n${errors.join('\n')}`;
            alert(message);
        },

        getStatusClasses(status) {
            const classes = {
                'NOT_FILED': 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300',
                'SUBMITTED': 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400',
                'PROCESSING': 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400',
                'ACCEPTED': 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400',
                'ACCEPTED_WITH_ERRORS': 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400',
                'REJECTED': 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400'
            };
            return classes[status] || 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300';
        },

        formatStatus(status) {
            const map = {
                'NOT_FILED': 'Not Filed',
                'SUBMITTED': 'Submitted',
                'PROCESSING': 'Processing',
                'ACCEPTED': 'Accepted',
                'ACCEPTED_WITH_ERRORS': 'Accepted*',
                'REJECTED': 'Rejected'
            };
            return map[status] || status || 'Not Filed';
        }
    };
}
</script>
{% endblock %}
